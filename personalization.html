<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>二级社党 - 个性化设置</title>
    <link rel="stylesheet" href="css/styles.css">
    <script src="js/app.js?v=7"></script>
</head>
<body>
    <button class="mobile-menu-btn" onclick="toggleSidebar()">☰</button>
    <div class="sidebar-overlay" onclick="closeSidebar()"></div>
    
    <div class="sidebar">
        <button class="sidebar-close" onclick="closeSidebar()">✕</button>
        <h2>二级社党</h2>
        <nav>
            <ul>
                <li><a href="home.html">首页</a></li>
                <li><a href="square.html">交流广场</a></li>
                <li><a href="profile.html">个人信息</a></li>
                <li><a href="personalization.html" class="active">个性化</a></li>
                <li id="membersNav"><a href="members.html">查看人员</a></li>
                <li><a href="#" onclick="logout()">退出登录</a></li>
                <li><button class="easter-egg-btn" onclick="showEasterEgg()">千万别点</button></li>
            </ul>
        </nav>
    </div>
    
    <div class="content">
        <div class="personalization-section">
            <h3>个性化设置</h3>
            <p class="section-description">自定义网站的颜色主题，设置将自动保存并同步到所有设备</p>
            
            <div class="color-settings-grid">
                <div class="color-setting-item">
                    <label for="primaryColor">主色</label>
                    <div class="color-input-wrapper">
                        <input type="color" id="primaryColor" value="#ffffff" onchange="previewColors()">
                        <span id="primaryColorValue">#ffffff</span>
                    </div>
                    <p class="color-description">用于主要按钮、卡片背景等</p>
                </div>
                
                <div class="color-setting-item">
                    <label for="secondaryColor">辅色</label>
                    <div class="color-input-wrapper">
                        <input type="color" id="secondaryColor" value="#87CEEB" onchange="previewColors()">
                        <span id="secondaryColorValue">#87CEEB</span>
                    </div>
                    <p class="color-description">用于次要元素、高亮显示等</p>
                </div>
                
                <div class="color-setting-item">
                    <label for="backgroundColor">背景色</label>
                    <div class="color-input-wrapper">
                        <input type="color" id="backgroundColor" value="#1a365d" onchange="previewColors()">
                        <span id="backgroundColorValue">#1a365d</span>
                    </div>
                    <p class="color-description">用于页面背景</p>
                </div>
                
                <div class="color-setting-item">
                    <label for="textColor">文字色</label>
                    <div class="color-input-wrapper">
                        <input type="color" id="textColor" value="#1a365d" onchange="previewColors()">
                        <span id="textColorValue">#1a365d</span>
                    </div>
                    <p class="color-description">用于主要文字内容</p>
                </div>
            </div>
            
            <div class="preview-section">
                <h4>预览效果</h4>
                <div class="preview-box" id="previewBox">
                    <div class="preview-content">
                        <h5>预览标题</h5>
                        <p>这是一段预览文字，用于展示颜色设置的效果。</p>
                        <button class="preview-button">预览按钮</button>
                    </div>
                </div>
            </div>
            
            <div class="action-buttons">
                <button class="btn btn-primary" onclick="saveColorSettings()">保存设置</button>
                <button class="btn btn-secondary" onclick="resetToDefault()">恢复默认</button>
            </div>
        </div>
    </div>
    
    <script>
        let currentColorSettings = {
            primary: '#ffffff',
            secondary: '#87CEEB',
            background: '#1a365d',
            text: '#1a365d'
        };
        
        const defaultColorSettings = {
            primary: '#ffffff',
            secondary: '#87CEEB',
            background: '#1a365d',
            text: '#1a365d'
        };
        
        window.onload = async function() {
            await init();
            if (!checkLogin()) return;
            
            setActiveNav('personalization.html');
            updateUI();
            loadColorSettings();
        };
        
        function loadColorSettings() {
            const savedSettings = localStorage.getItem('colorSettings');
            if (savedSettings) {
                currentColorSettings = JSON.parse(savedSettings);
            }
            
            document.getElementById('primaryColor').value = currentColorSettings.primary;
            document.getElementById('secondaryColor').value = currentColorSettings.secondary;
            document.getElementById('backgroundColor').value = currentColorSettings.background;
            document.getElementById('textColor').value = currentColorSettings.text;
            
            updateColorValueDisplays();
            applyColorSettings();
        }
        
        function updateColorValueDisplays() {
            document.getElementById('primaryColorValue').textContent = currentColorSettings.primary;
            document.getElementById('secondaryColorValue').textContent = currentColorSettings.secondary;
            document.getElementById('backgroundColorValue').textContent = currentColorSettings.background;
            document.getElementById('textColorValue').textContent = currentColorSettings.text;
        }
        
        function previewColors() {
            currentColorSettings.primary = document.getElementById('primaryColor').value;
            currentColorSettings.secondary = document.getElementById('secondaryColor').value;
            currentColorSettings.background = document.getElementById('backgroundColor').value;
            currentColorSettings.text = document.getElementById('textColor').value;
            
            updateColorValueDisplays();
            applyColorSettings();
        }
        
        function applyColorSettings() {
            const root = document.documentElement;
            
            root.style.setProperty('--primary-color', currentColorSettings.primary);
            root.style.setProperty('--secondary-color', currentColorSettings.secondary);
            root.style.setProperty('--background-color', currentColorSettings.background);
            root.style.setProperty('--text-color', currentColorSettings.text);
            
            document.body.style.background = currentColorSettings.background;
            document.body.style.color = currentColorSettings.text;
            
            const previewBox = document.getElementById('previewBox');
            if (previewBox) {
                previewBox.style.background = currentColorSettings.primary;
                previewBox.style.color = currentColorSettings.text;
                
                const previewButton = previewBox.querySelector('.preview-button');
                if (previewButton) {
                    previewButton.style.background = currentColorSettings.secondary;
                    previewButton.style.color = getContrastColor(currentColorSettings.secondary);
                }
            }
            
            const sidebar = document.querySelector('.sidebar');
            if (sidebar) {
                sidebar.style.background = currentColorSettings.primary;
                sidebar.style.color = currentColorSettings.text;
            }
            
            const loginBox = document.querySelector('.login-box');
            if (loginBox) {
                loginBox.style.background = currentColorSettings.primary;
                loginBox.style.color = currentColorSettings.text;
            }
            
            const content = document.querySelector('.content');
            if (content) {
                content.style.color = currentColorSettings.text;
            }
        }
        
        function getContrastColor(hexcolor) {
            const r = parseInt(hexcolor.substr(1, 2), 16);
            const g = parseInt(hexcolor.substr(3, 2), 16);
            const b = parseInt(hexcolor.substr(5, 2), 16);
            const yiq = ((r * 299) + (g * 587) + (b * 114)) / 1000;
            return (yiq >= 128) ? '#000000' : '#ffffff';
        }
        
        async function saveColorSettings() {
            currentColorSettings.primary = document.getElementById('primaryColor').value;
            currentColorSettings.secondary = document.getElementById('secondaryColor').value;
            currentColorSettings.background = document.getElementById('backgroundColor').value;
            currentColorSettings.text = document.getElementById('textColor').value;
            
            localStorage.setItem('colorSettings', JSON.stringify(currentColorSettings));
            
            try {
                const config = await loadConfig();
                const response = await fetch(`https://api.jsonbin.io/v3/b/${config.jsonbin.bins.colorSettings}`, {
                    method: 'GET',
                    headers: {
                        'X-Master-Key': config.jsonbin.apiKey
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    const colorSettingsData = data.record || {};
                    colorSettingsData[currentUser.code] = currentColorSettings;
                    
                    const updateResponse = await fetch(`https://api.jsonbin.io/v3/b/${config.jsonbin.bins.colorSettings}`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-Master-Key': config.jsonbin.apiKey
                        },
                        body: JSON.stringify(colorSettingsData)
                    });
                    
                    if (updateResponse.ok) {
                        alert('颜色设置已保存并同步到所有设备！');
                    } else {
                        alert('设置已保存到本地，但同步到云端失败');
                    }
                } else {
                    alert('设置已保存到本地，但同步到云端失败');
                }
            } catch (error) {
                console.error('保存颜色设置失败:', error);
                alert('设置已保存到本地');
            }
        }
        
        async function resetToDefault() {
            if (confirm('确定要恢复默认颜色设置吗？')) {
                currentColorSettings = { ...defaultColorSettings };
                
                document.getElementById('primaryColor').value = currentColorSettings.primary;
                document.getElementById('secondaryColor').value = currentColorSettings.secondary;
                document.getElementById('backgroundColor').value = currentColorSettings.background;
                document.getElementById('textColor').value = currentColorSettings.text;
                
                updateColorValueDisplays();
                applyColorSettings();
                
                localStorage.setItem('colorSettings', JSON.stringify(currentColorSettings));
                
                try {
                    const config = await loadConfig();
                    const response = await fetch(`https://api.jsonbin.io/v3/b/${config.jsonbin.bins.colorSettings}`, {
                        method: 'GET',
                        headers: {
                            'X-Master-Key': config.jsonbin.apiKey
                        }
                    });
                    
                    if (response.ok) {
                        const data = await response.json();
                        const colorSettingsData = data.record || {};
                        delete colorSettingsData[currentUser.code];
                        
                        const updateResponse = await fetch(`https://api.jsonbin.io/v3/b/${config.jsonbin.bins.colorSettings}`, {
                            method: 'PUT',
                            headers: {
                                'Content-Type': 'application/json',
                                'X-Master-Key': config.jsonbin.apiKey
                            },
                            body: JSON.stringify(colorSettingsData)
                        });
                    }
                } catch (error) {
                    console.error('恢复默认设置失败:', error);
                }
                
                alert('已恢复默认颜色设置！');
            }
        }
        
        function showEasterEgg() {
            document.getElementById('easterEggModal').classList.add('active');
        }
        
        function confirmEasterEgg() {
            window.open('https://www.bilibili.com/video/BV1he4y1w7wB?t=12.4', '_blank');
            document.getElementById('easterEggModal').classList.remove('active');
        }
    </script>
    
    <div class="easter-egg-modal" id="easterEggModal">
        <div class="easter-egg-modal-content">
            <h3>⚠️ 警告</h3>
            <p>这可能会造成不可逆转的损伤！！！</p>
            <div class="easter-egg-buttons">
                <button class="easter-egg-confirm-red" onclick="confirmEasterEgg()">确定</button>
                <button class="easter-egg-confirm-blue" onclick="confirmEasterEgg()">确定</button>
            </div>
        </div>
    </div>
</body>
</html>